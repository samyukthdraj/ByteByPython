<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Civilians As Police (CAP) - Police Dashboard</title>
  <link rel="stylesheet" href="stylespdash.css">
</head>
<body>
    <div class="dashboard-container">
        <h1>Police Dashboard</h1>
        <div id="loading-message">Loading tickets...</div>
        <div class="ticket-list" id="ticket-list">
            <!-- Tickets will be loaded here -->
        </div>
        <button class="signout-button" onclick="signOut()">Sign Out</button>
    </div>

    <!-- Modal for ticket details -->
    <div id="ticketModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        // Authentication check function
        async function checkAuthentication() {
            const accessToken = localStorage.getItem('access_token');
            if (!accessToken) {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        // Fetch tickets function
        async function fetchPoliceTickets() {
            const loadingMessage = document.getElementById('loading-message');
            const ticketList = document.getElementById('ticket-list');
            
            try {
                if (!await checkAuthentication()) return;

                const response = await fetch('http://localhost:8000/police-tickets', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const tickets = await response.json();
                loadingMessage.style.display = 'none';
                ticketList.innerHTML = '';

                if (tickets.length === 0) {
                    ticketList.innerHTML = '<p>No tickets assigned.</p>';
                    return;
                }

                tickets.forEach(ticket => {
                    const ticketCard = createTicketCard(ticket);
                    ticketList.appendChild(ticketCard);
                });
            } catch (error) {
                handleFetchError(error, loadingMessage);
            }
        }

        // Create ticket card function
        function createTicketCard(ticket) {
            const ticketCard = document.createElement('div');
            ticketCard.classList.add('ticket-card');
            ticketCard.innerHTML = `
                <h3>Ticket #${ticket.ticket_number}</h3>
                <p>Crime Type: ${ticket.crime_type}</p>
                <p>Pincode: ${ticket.pincode}</p>
                <p>Status: ${ticket.status}</p>
                <div class="media-container">
                    ${createImageContent(ticket.image_url)}
                    ${createAudioContent(ticket.audio_url)}
                </div>
                <div class="ticket-actions">
                    <button onclick="viewTicketDetails('${ticket.ticket_number}')">
                        View Text Details
                    </button>
                    <button onclick="updateTicketStatus('${ticket.ticket_number}', 'In Progress')">
                        Set to In Progress
                    </button>
                    <button onclick="updateTicketStatus('${ticket.ticket_number}', 'Resolved')">
                        Set to Resolved
                    </button>
                    <button onclick="updateTicketStatus('${ticket.ticket_number}', 'Closed')">
                        Set to Closed
                    </button>
                </div>
            `;
            return ticketCard;
        }

        // Create image content
function createImageContent(imageUrl) {
    if (!imageUrl) return '<p>No image uploaded</p>';
    
    // Convert to thumbnail URL for better performance
    const processedUrl = processGoogleDriveUrl(imageUrl);
    return `
        <div class="image-container">
            <h4>Uploaded Image</h4>
            <img 
                src="${processedUrl}" 
                alt="Crime scene image"
                style="max-width: 100%; height: auto;"
                onerror="handleImageError(this)"
                data-original-url="${imageUrl}"
            />
        </div>
    `;
}

// Create audio content
function createAudioContent(audioUrl) {
    if (!audioUrl) return '<p>No audio uploaded</p>';
    
    const processedUrl = processGoogleDriveUrl(audioUrl, true);
    return `
        <div class="audio-container">
            <h4>Uploaded Audio</h4>
            <audio controls style="width: 100%;" onerror="handleAudioError(this)">
                <source src="${processedUrl}" type="audio/mpeg">
                <source src="${processedUrl}" type="audio/mp4">
                Your browser does not support the audio element.
            </audio>
            <a href="${processedUrl}" target="_blank" class="download-link">Download Audio</a>
        </div>
    `;
}

        // Process Google Drive URL
// Process Google Drive URL
// Process Google Drive URL
function processGoogleDriveUrl(url, isAudio = false) {
    if (!url) return '';

    // Handle different Google Drive URL formats
    let fileId = '';
    
    // Handle sharing URL format
    if (url.includes('drive.google.com/file/d/')) {
        fileId = url.split('/file/d/')[1].split('/')[0];
    }
    // Handle old format
    else if (url.includes('drive.google.com/open?id=')) {
        fileId = url.split('open?id=')[1].split('&')[0];
    }
    // Handle view format
    else if (url.includes('drive.google.com/uc?id=')) {
        fileId = url.split('uc?id=')[1].split('&')[0];
    }
    // Handle direct file ID
    else if (url.match(/^[a-zA-Z0-9_-]{25,}$/)) {
        fileId = url;
    } else {
        console.warn('Unrecognized Google Drive URL format:', url);
        return url;
    }

    // For images, use the thumbnail API which is more reliable
    if (!isAudio) {
        return `https://drive.google.com/thumbnail?id=${fileId}&sz=w1000`;
    }
    
    // For audio, use the direct download link
    return `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media&key=YOUR_API_KEY`;
}

// Enhanced error handlers
function handleImageError(img) {
    const originalUrl = img.getAttribute('data-original-url');
    console.warn('Image failed to load:', originalUrl);
    
    // Replace with error message and direct link
    const container = img.closest('.image-container');
    container.innerHTML = `
        <div class="media-error">
            <p>Unable to load image directly. Please ensure the file is publicly accessible.</p>
            <a href="${originalUrl}" target="_blank" class="view-link">
                View Image in Google Drive
            </a>
        </div>
    `;
}

function handleAudioError(audio) {
    const container = audio.closest('.audio-container');
    const sourceUrl = audio.querySelector('source').src;
    
    container.innerHTML = `
        <div class="media-error">
            <p>Unable to play audio directly. Please ensure the file is publicly accessible.</p>
            <a href="${sourceUrl}" target="_blank" class="download-link">
                Download Audio File
            </a>
        </div>
    `;
}

        // Update ticket status function
        async function updateTicketStatus(ticketNumber, newStatus) {
            try {
                const response = await fetch(`http://localhost:8000/update-ticket/${ticketNumber}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                await response.json();
                await fetchPoliceTickets();
                alert(`Ticket #${ticketNumber} status updated to ${newStatus}`);
            } catch (error) {
                handleUpdateError(error);
            }
        }

        // View ticket details function (modal remains for text details)
        async function viewTicketDetails(ticketNumber) {
            try {
                const response = await fetch(`http://localhost:8000/ticket-details/${ticketNumber}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const ticket = await response.json();
                displayTicketModal(ticket);
            } catch (error) {
                console.error('Error fetching ticket details:', error);
                alert('Error fetching ticket details. Please try again.');
            }
        }

        // Display ticket modal function (unchanged)
        function displayTicketModal(ticket) {
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <h2>Ticket Details #${ticket.ticket_number}</h2>
                <p><strong>Reported by:</strong> ${ticket.user_name}</p>
                <p><strong>Crime Type:</strong> ${ticket.crime_type}</p>
                <p><strong>Pincode:</strong> ${ticket.pincode}</p>
                <p><strong>Phone Number:</strong> ${ticket.phone_number}</p>
                <p><strong>Status:</strong> ${ticket.status}</p>
                <p><strong>Description:</strong> ${ticket.description || 'No description provided'}</p>
                <p><strong>Created at:</strong> ${new Date(ticket.created_at).toLocaleString()}</p>
            `;
            
            document.getElementById('ticketModal').style.display = 'block';
        }

        // Modal control functions
        function closeModal() {
            document.getElementById('ticketModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('ticketModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // Sign out function
        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                localStorage.removeItem('access_token');
                window.location.href = 'login.html';
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', fetchPoliceTickets);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Civilians As Police (CAP) - Police Dashboard</title>
  <link rel="stylesheet" href="stylespdash.css">
</head>
<body>
  <div class="dashboard-container">
    <h1>Police Dashboard</h1>
    <div id="loading-message">Loading tickets...</div>
    <div class="ticket-list" id="ticket-list">
      <!-- Dynamically generate ticket cards here -->
    </div>
    <button class="signout-button" onclick="signOut()">Sign Out</button>
  </div>

  <!-- Modal for ticket details -->
  <div id="ticketModal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="closeModal()">&times;</span>
      <div id="modalContent"></div>
    </div>
  </div>

  <script>
    // Function to check authentication
    async function checkAuthentication() {
      const accessToken = localStorage.getItem('access_token');
      if (!accessToken) {
        window.location.href = 'login.html';
        return false;
      }
      return true;
    }

    // Police login function
    async function policeLogin(event) {
      event.preventDefault();
      const stationId = document.getElementById('stationId').value;
      const stationPassword = document.getElementById('stationPassword').value;

      try {
        const response = await fetch('http://localhost:8000/police-login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            stationId: stationId,
            stationPassword: stationPassword
          })
        });

        const data = await response.json();

        if (data.success) {
          localStorage.setItem('access_token', data.access_token);
          window.location.href = 'police_dashboard.html';
        } else {
          alert('Login failed');
        }
      } catch (error) {
        console.error('Login error:', error);
        alert('An error occurred during login');
      }
    }

    // Fetch tickets function
    async function fetchPoliceTickets() {
      const loadingMessage = document.getElementById('loading-message');
      const ticketList = document.getElementById('ticket-list');
      
      try {
        if (!await checkAuthentication()) return;

        const response = await fetch('http://localhost:8000/police-tickets', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
        }

        const tickets = await response.json();
        loadingMessage.style.display = 'none';
        ticketList.innerHTML = '';

        if (tickets.length === 0) {
          ticketList.innerHTML = '<p>No tickets assigned.</p>';
          return;
        }

        tickets.forEach(ticket => {
          const ticketCard = document.createElement('div');
          ticketCard.classList.add('ticket-card');
          ticketCard.innerHTML = `
            <h3>Ticket #${ticket.ticket_number}</h3>
            <p>Crime Type: ${ticket.crime_type}</p>
            <p>Pincode: ${ticket.pincode}</p>
            <p>Status: ${ticket.status}</p>
            <div class="ticket-actions">
              <button onclick="viewTicketDetails('${ticket.ticket_number}')">
                View Details
              </button>
              <button onclick="updateTicketStatus('${ticket.ticket_number}', 'In Progress')">
                Set to In Progress
              </button>
              <button onclick="updateTicketStatus('${ticket.ticket_number}', 'Resolved')">
                Set to Resolved
              </button>
              <button onclick="updateTicketStatus('${ticket.ticket_number}', 'Closed')">
                Set to Closed
              </button>
            </div>
          `;
          ticketList.appendChild(ticketCard);
        });
      } catch (error) {
        console.error('Error fetching police tickets:', error);
        loadingMessage.textContent = `An error occurred while fetching tickets: ${error.message}`;
        loadingMessage.style.color = 'red';
        if (error.message.includes('401')) {
          alert('Authentication failed. Please log in again.');
          localStorage.removeItem('access_token');
          window.location.href = 'login.html';
        }
      }
    }

    // View ticket details function
    async function viewTicketDetails(ticketNumber) {
      try {
        const response = await fetch(`http://localhost:8000/ticket-details/${ticketNumber}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const ticket = await response.json();
        const modalContent = document.getElementById('modalContent');
        
        modalContent.innerHTML = `
          <h2>Ticket Details #${ticket.ticket_number}</h2>
          <p><strong>Reported by:</strong> ${ticket.user_name}</p>
          <p><strong>Crime Type:</strong> ${ticket.crime_type}</p>
          <p><strong>Pincode:</strong> ${ticket.pincode}</p>
          <p><strong>Phone Number:</strong> ${ticket.phone_number}</p>
          <p><strong>Status:</strong> ${ticket.status}</p>
          <p><strong>Description:</strong> ${ticket.description || 'No description provided'}</p>
          <p><strong>Created at:</strong> ${new Date(ticket.created_at).toLocaleString()}</p>
          
          <div class="media-container">
            ${ticket.image_url ? `
              <h3>Uploaded Image</h3>
              <img src="${ticket.image_url}" alt="Crime scene image">
            ` : ''}
            
            ${ticket.audio_url ? `
              <h3>Uploaded Audio</h3>
              <audio controls>
                <source src="${ticket.audio_url}" type="audio/mpeg">
                Your browser does not support the audio element.
              </audio>
            ` : ''}
          </div>
        `;

        document.getElementById('ticketModal').style.display = 'block';
      } catch (error) {
        console.error('Error fetching ticket details:', error);
        alert('Error fetching ticket details. Please try again.');
      }
    }

    // Update ticket status function
    async function updateTicketStatus(ticketNumber, newStatus) {
      try {
        const response = await fetch(`http://localhost:8000/update-ticket/${ticketNumber}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status: newStatus })
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
        }

        const result = await response.json();
        await fetchPoliceTickets();
        alert(`Ticket #${ticketNumber} status updated to ${newStatus}`);
      } catch (error) {
        console.error('Error updating ticket status:', error);
        if (error.message.includes('401')) {
          alert('Authentication failed. Please log in again.');
          localStorage.removeItem('access_token');
          window.location.href = 'login.html';
        } else {
          alert(`Failed to update ticket status: ${error.message}`);
        }
      }
    }

    // Modal control functions
    function closeModal() {
      document.getElementById('ticketModal').style.display = 'none';
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('ticketModal');
      if (event.target === modal) {
        modal.style.display = 'none';
      }
    }

    // Sign out function
    function signOut() {
      const confirmSignOut = confirm('Are you sure you want to sign out?');
      if (confirmSignOut) {
        localStorage.removeItem('access_token');
        window.location.href = 'login.html';
      }
    }

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', fetchPoliceTickets);
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Civilians As Police (CAP)</title>
  <link rel="stylesheet" href="styles.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
</head>
<body>
  <div class="window">
    <h1 class="title">Civilians As Police (CAP)</h1>

    <!-- User Name Input -->
    <div class="form-group">
      <label for="userName">Your Name:</label>
      <input type="text" id="userName" placeholder="Enter your name">
    </div>

    <!-- Image Upload -->
    <div class="form-group">
      <label for="uploadImage">Upload Image:</label>
      <input type="file" id="uploadImage" accept="image/*">
    </div>

<!-- Voice Recorder -->
<div class="form-group">
    <label>Record Voice Note:</label>
    <div id="voiceRecorder">
      <button id="startRecording" onclick="startRecording()" class="record-button">
        <i class="fas fa-microphone"></i>
      </button>
      <button id="stopRecording" onclick="stopRecording()" class="record-button" style="display: none;">
        <i class="fas fa-stop-circle"></i>
      </button>
      <button id="removeRecording" onclick="removeRecording()" class="remove-button" style="display: none;">
        <i class="fas fa-times"></i>
      </button>
      <audio id="recordedAudio" controls style="display: none;"></audio>
    </div>
  </div>
  
  
    <!-- Hidden Audio File Input -->
    <input type="file" id="uploadVoice" style="display: none;">

    <!-- Pincode Input -->
    <div class="form-group">
      <label for="pincode">Enter Pincode:</label>
      <input type="text" id="pincode" placeholder="e.g., 123456">
    </div>

    <!-- Police Station Dropdown -->
    <div class="form-group">
      <label for="policeStation">Nearest Police Station:</label>
      <select id="policeStation">
        <option value="">Select a station</option>
        <option value="Central Police Station">Central Police Station</option>
        <option value="Station 2">Station 2</option>
        <option value="Station 3">Station 3</option>
      </select>
    </div>

    <!-- Type of Crime Dropdown -->
    <div class="form-group">
      <label for="crimeType">Type of Crime:</label>
      <select id="crimeType">
        <option value="">Select a crime type</option>
        <option value="theft">Theft</option>
        <option value="vandalism">Vandalism</option>
        <option value="assault">Assault</option>
        <option value="fraud">Fraud</option>
        <option value="others">Others</option>
      </select>
      <div id="customCrimeType" style="display: none; margin-top: 10px;">
        <input type="text" id="customCrimeTypeInput" placeholder="Enter custom crime type">
      </div>
    </div>

    <!-- Phone Number Input -->
    <div class="form-group">
      <label for="phoneNumber">Your Phone Number:</label>
      <input type="text" id="phoneNumber" placeholder="e.g., 1234567890">
    </div>

    <!-- Description Box -->
    <div class="form-group">
      <label for="description">Description:</label>
      <textarea id="description" placeholder="Enter crime description here..."></textarea>
    </div>

    <!-- Submit Button -->
    <div class="form-group">
      <button class="submit-button" onclick="submitReport()">Submit Report</button>
    </div>
  </div>

  <script>

let mediaRecorder;
let audioChunks = [];

async function startRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);

    // Store the username and timestamp at the start of the recording
    const timestamp = Date.now();
    const userName = document.getElementById('userName').value || 'anonymous';
    const sanitizedUsername = userName.replace(/[^a-zA-Z0-9]/g, '_'); // Sanitize username
    const uniqueFileName = `recorded_audio_${sanitizedUsername}_${timestamp}.webm`; // Create unique file name

    mediaRecorder.ondataavailable = event => {
      audioChunks.push(event.data);
    };

    mediaRecorder.onstop = () => {
      const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
      audioChunks = [];

      const audioUrl = URL.createObjectURL(audioBlob);
      const recordedAudio = document.getElementById('recordedAudio');
      recordedAudio.src = audioUrl;
      recordedAudio.style.display = 'block';

      // Create a file-like object for upload with the generated filename
      const file = new File([audioBlob], uniqueFileName, { type: 'audio/webm' });
      const uploadVoice = document.getElementById('uploadVoice');
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      uploadVoice.files = dataTransfer.files;
    };

    mediaRecorder.start();
    document.getElementById('startRecording').style.display = 'none'; // Hide start recording button
    document.getElementById('stopRecording').style.display = 'inline-block'; // Show stop recording button
    document.getElementById('removeRecording').style.display = 'none'; // Hide remove recording button

  } catch (error) {
    console.error('Error starting recording:', error);
    alert('Failed to access microphone. Please ensure your microphone is enabled.');
  }
}



// Stop recording
function stopRecording() {
  if (mediaRecorder && mediaRecorder.state !== 'inactive') {
    mediaRecorder.stop();
    document.getElementById('startRecording').style.display = 'inline-block'; // Show start recording button
    document.getElementById('stopRecording').style.display = 'none'; // Hide stop recording button
    document.getElementById('removeRecording').style.display = 'inline-block'; // Show remove recording button
  }
}


// Remove the recorded audio and reset the state
function removeRecording() {
  // Reset the audio player
  const recordedAudio = document.getElementById('recordedAudio');
  recordedAudio.src = '';
  recordedAudio.style.display = 'none';

  // Clear the file input
  const uploadVoice = document.getElementById('uploadVoice');
  const dataTransfer = new DataTransfer();
  uploadVoice.files = dataTransfer.files;

  // Reset buttons
  document.getElementById('startRecording').style.display = 'inline-block'; // Show start recording button
  document.getElementById('stopRecording').style.display = 'none'; // Hide stop recording button
  document.getElementById('removeRecording').style.display = 'none'; // Hide remove recording button
}

async function showLoadingPopup() {
  // Create the loading popup
  const popup = document.createElement("div");
  popup.innerHTML = `
    <div id="report-popup" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 2px solid blue; z-index: 1000; text-align: center;">
        <h2>Submitting Report...</h2>
        <div>Loading...</div> <!-- Static loading text -->
    </div>
  `;
  document.body.appendChild(popup); // Add to the body of the document
  
  // Force reflow to ensure the popup is displayed immediately
  popup.offsetHeight; // Accessing this forces the browser to reflow the DOM
  return popup; // Return the popup element to modify it later
}


async function submitReport() {
  const userName = document.getElementById("userName").value;
  const pincode = document.getElementById("pincode").value;
  const policeStation = document.getElementById("policeStation").value;
  const phoneNumber = document.getElementById("phoneNumber").value;
  const crimeType =
    document.getElementById("crimeType").value === "others"
      ? document.getElementById("customCrimeTypeInput").value
      : document.getElementById("crimeType").value;
  const description = document.getElementById("description").value;

  // Image and voice file handling
  const imageFile = document.getElementById("uploadImage").files[0];
  const voiceFile = document.getElementById("uploadVoice").files[0];

  // FormData to send data to the backend
  const formData = new FormData();
  formData.append("user_name", userName);
  formData.append("pincode", pincode);
  formData.append("police_station", policeStation);
  formData.append("phone_number", phoneNumber);
  formData.append("crime_type", crimeType);
  formData.append("description", description);

  // Append files if they exist
  if (imageFile) {
    formData.append("image_file", imageFile);
  }
  if (voiceFile) {
    formData.append("voice_file", voiceFile);
  }

  // Show the "Submitting Report..." popup
  const popup = await showLoadingPopup(); // Important: await here

  try {
    // Fetch the access token from localStorage
    const accessToken = localStorage.getItem("access_token");
    if (!accessToken) {
      throw new Error("No access token found. Please log in.");
    }

    // Send the POST request to the `/upload-crime-report` endpoint
    const response = await fetch("http://localhost:8000/upload-crime-report", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${accessToken}`,
      },
      body: formData,
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.detail || "Failed to submit report");
    }

    const result = await response.json();

    // Update the popup to show success message
    updatePopupToSuccess(popup, result.ticket_number);
  } catch (error) {
      // remove the loader
    popup.remove();
    console.error("Error submitting report:", error);
    alert(error.message || "Failed to submit report. Please try again.");
  }
}



function updatePopupToSuccess(popup, ticketNumber) {
  // Find the existing popup and update its content to success message
  const popupContent = document.getElementById("report-popup");
  popupContent.innerHTML = `
    <h2>Report Submitted Successfully!</h2>
    <p>Your Ticket Number is: <strong>${ticketNumber}</strong></p>
    <button onclick="this.parentElement.remove(); window.location.href='user_dashboard.html'">View Dashboard</button>
  `;
}




async function analyzeImage(file) {
  const API_KEY = 'AIzaSyBXr_EYbwC-JA4tJ_F37fctbzgKDcxTzZo'; // Replace with your actual API key

  const reader = new FileReader();
  reader.readAsDataURL(file);

  return new Promise((resolve, reject) => {
    reader.onload = async () => {
      const base64Image = reader.result.split(',')[1];

      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${API_KEY}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            contents: [{
              parts: [
                { text: 'Analyze this image and provide the following in a structured JSON format: {"keywords": [], "crime_type": "", "description": ""}. If no specific crime is evident, set crime_type to null. Make crime_type match existing dropdown options (theft, vandalism, assault, fraud, or others). If not in the list then the real type should be appended in the dropdown and selected automatically. If not a crime then give in the description not a crime and update the type of crime as No Criminal Activity.' },
                { 
                  inlineData: {
                    mimeType: 'image/jpeg',
                    data: base64Image,
                  },
                },
              ],
            }],
          }),
        });

        const data = await response.json();
        let analysisResult;
        try {
          // More robust parsing to handle potential formatting issues
          const responseText = data.candidates[0].content.parts[0].text
            .replace(/```json/g, '')
            .replace(/```/g, '')
            .trim();
          
          analysisResult = JSON.parse(responseText);
        } catch (parseError) {
          console.error('Failed to parse JSON:', parseError);
          throw new Error('Unable to parse Gemini response');
        }

        const descriptionBox = document.getElementById("description");
        const crimeTypeDropdown = document.getElementById("crimeType");
        const customCrimeTypeInput = document.getElementById("customCrimeTypeInput");
        const customCrimeTypeContainer = document.getElementById("customCrimeType");

        // Clear the description field
        descriptionBox.value = "";

        // Append keywords and description to the description
        descriptionBox.value = `Keywords: ${analysisResult.keywords.join(", ")}\n\nDescription: ${analysisResult.description}`;

        // Update crime type dropdown
        if (analysisResult.crime_type) {
          const normalizedCrimeType = analysisResult.crime_type.toLowerCase();
          
          const existingOption = Array.from(crimeTypeDropdown.options).find(
            option => option.value.toLowerCase() === normalizedCrimeType
          );

          if (existingOption) {
            crimeTypeDropdown.value = existingOption.value;
            customCrimeTypeContainer.style.display = 'none';
          } else {
            crimeTypeDropdown.value = 'others';
            customCrimeTypeInput.value = analysisResult.crime_type;
            customCrimeTypeContainer.style.display = 'block';
          }
        }

        resolve(analysisResult);
      } catch (error) {
        console.error('Error analyzing image:', error);
        alert('Image analysis failed. Please try again or manually enter details.');
        reject(error);
      }
    };

    reader.onerror = (error) => {
      console.error('Error reading file:', error);
      alert('Error reading image file. Please try again.');
      reject(error);
    };
  });
}

document.getElementById("uploadImage").addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (file) {
    analyzeImage(file);
  }
});

document.getElementById("crimeType").addEventListener("change", function() {
  const customInput = document.getElementById('customCrimeType');
  customInput.style.display = this.value === 'others' ? 'block' : 'none';
});









  async function submitReport() {
  const userName = document.getElementById("userName").value;
  const pincode = document.getElementById("pincode").value;
  const policeStation = document.getElementById("policeStation").value;
  const phoneNumber = document.getElementById("phoneNumber").value;
  const crimeType =
    document.getElementById("crimeType").value === "others"
      ? document.getElementById("customCrimeTypeInput").value
      : document.getElementById("crimeType").value;
  const description = document.getElementById("description").value;

  // Image and voice file handling
  const imageFile = document.getElementById("uploadImage").files[0];
  const voiceFile = document.getElementById("uploadVoice").files[0];

  // FormData to send data to the backend
  const formData = new FormData();
  formData.append("user_name", userName);
  formData.append("pincode", pincode);
  formData.append("police_station", policeStation);
  formData.append("phone_number", phoneNumber);
  formData.append("crime_type", crimeType);
  formData.append("description", description);

  // Append files if they exist
  if (imageFile) {
    formData.append("image_file", imageFile); // Match the backend field name
  }
  if (voiceFile) {
    formData.append("voice_file", voiceFile); // Match the backend field name
  }

    // Show the "Submitting Report..." popup
    const popup = await showLoadingPopup(); // Important: await here

  try {
    // Fetch the access token from localStorage
    const accessToken = localStorage.getItem("access_token");
    if (!accessToken) {
      throw new Error("No access token found. Please log in.");
    }

    // Send the POST request to the `/upload-crime-report` endpoint
    const response = await fetch("http://localhost:8000/upload-crime-report", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${accessToken}`,
      },
      body: formData,
    });

    if (!response.ok) {
        popup.remove();
      const errorData = await response.json();
      throw new Error(errorData.detail || "Failed to submit report");
    }

    const result = await response.json();

    // Show success popup with ticket number
    updatePopupToSuccess(popup, result.ticket_number);
  } catch (error) {
    popup.remove();
    console.error("Error submitting report:", error);
    alert(error.message || "Failed to submit report. Please try again.");
  }
}


async function analyzeImage(file) {
        const API_KEY = 'AIzaSyBXr_EYbwC-JA4tJ_F37fctbzgKDcxTzZo'; // Replace with your actual API key

        const reader = new FileReader();
        reader.readAsDataURL(file);
        
        return new Promise((resolve, reject) => {
            reader.onload = async () => {
                const base64Image = reader.result.split(',')[1];

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${API_KEY}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: 'Analyze this image and provide the following in a structured JSON format: {"keywords": [], "crime_type": "", "description": ""}. If no specific crime is evident, set crime_type to null. Make crime_type match existing dropdown options (theft, vandalism, assault, fraud, or others). If not in the list then the real type should be appended in the dropdown and selected automatically. If not a crime then give in the description not a crime and update the type of crime as No Criminal Activity.' },
                                    { 
                                        inlineData: {
                                            mimeType: 'image/jpeg',
                                            data: base64Image
                                        }
                                    }
                                ]
                            }]
                        })
                    });

                    const data = await response.json();
                    let analysisResult;
                    try {
                        // More robust parsing to handle potential formatting issues
                        const responseText = data.candidates[0].content.parts[0].text
                            .replace(/```json/g, '')
                            .replace(/```/g, '')
                            .trim();
                        
                        analysisResult = JSON.parse(responseText);
                    } catch (parseError) {
                        console.error('Failed to parse JSON:', parseError);
                        throw new Error('Unable to parse Gemini response');
                    }

                    const descriptionBox = document.getElementById("description");
                    const crimeTypeDropdown = document.getElementById("crimeType");
                    const customCrimeTypeInput = document.getElementById("customCrimeTypeInput");
                    const customCrimeTypeContainer = document.getElementById("customCrimeType");

                    // Clear the description field
                    descriptionBox.value = "";

                    // Append keywords and description to the description
                    descriptionBox.value = `Keywords: ${analysisResult.keywords.join(", ")}\n\nDescription: ${analysisResult.description}`;

                    // Update crime type dropdown
                    if (analysisResult.crime_type) {
                        // Normalize crime type to match dropdown options
                        const normalizedCrimeType = analysisResult.crime_type.toLowerCase();
                        
                        // Check if the crime type matches any existing options
                        const existingOption = Array.from(crimeTypeDropdown.options).find(
                            option => option.value.toLowerCase() === normalizedCrimeType
                        );

                        if (existingOption) {
                            // Select the matching existing option
                            crimeTypeDropdown.value = existingOption.value;
                            customCrimeTypeContainer.style.display = 'none';
                        } else {
                            // If no match, select 'others' and set the custom input
                            crimeTypeDropdown.value = 'others';
                            customCrimeTypeInput.value = analysisResult.crime_type;
                            customCrimeTypeContainer.style.display = 'block';
                        }
                    }

                    resolve(analysisResult);
                } catch (error) {
                    console.error('Error analyzing image:', error);
                    alert('Image analysis failed. Please try again or manually enter details.');
                    reject(error);
                }
            };

            reader.onerror = (error) => {
                console.error('Error reading file:', error);
                alert('Error reading image file. Please try again.');
                reject(error);
            };
        });
    }

    document.getElementById("uploadImage").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        analyzeImage(file);
      }
    });

    document.getElementById("crimeType").addEventListener("change", function() {
      const customInput = document.getElementById('customCrimeType');
      customInput.style.display = this.value === 'others' ? 'block' : 'none';
    });
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Civilians As Police (CAP)</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>`
  <div class="window">
    <h1 class="title">Civilians As Police (CAP)</h1>

    <!-- User Name Input -->
    <div class="form-group">
      <label for="userName">Your Name:</label>
      <input type="text" id="userName" placeholder="Enter your name">
    </div>

    <!-- Image Upload -->
    <div class="form-group">
      <label for="uploadImage">Upload Image:</label>
      <input type="file" id="uploadImage" accept="image/*">
    </div>

    <!-- Voice Note Upload -->
    <div class="form-group">
      <label for="uploadVoice">Upload Voice:</label>
      <input type="file" id="uploadVoice" accept="audio/*">
    </div>

    <!-- Pincode Input -->
    <div class="form-group">
      <label for="pincode">Enter Pincode:</label>
      <input type="text" id="pincode" placeholder="e.g., 123456">
    </div>

    <!-- Police Station Dropdown -->
    <div class="form-group">
      <label for="policeStation">Nearest Police Station:</label>
      <select id="policeStation">
        <option value="">Select a station</option>
        <option value="Central Police Station">Central Police Station</option>
        <option value="Station 2">Station 2</option>
        <option value="Station 3">Station 3</option>
      </select>
    </div>

    <!-- Type of Crime Dropdown -->
    <div class="form-group">
      <label for="crimeType">Type of Crime:</label>
      <select id="crimeType">
        <option value="">Select a crime type</option>
        <option value="theft">Theft</option>
        <option value="vandalism">Vandalism</option>
        <option value="assault">Assault</option>
        <option value="fraud">Fraud</option>
        <option value="others">Others</option>
      </select>
      <div id="customCrimeType" style="display: none; margin-top: 10px;">
        <input type="text" id="customCrimeTypeInput" placeholder="Enter custom crime type">
      </div>
    </div>

    <!-- Phone Number Input -->
    <div class="form-group">
      <label for="phoneNumber">Your Phone Number:</label>
      <input type="text" id="phoneNumber" placeholder="e.g., 1234567890">
    </div>

    <!-- Description Box -->
    <div class="form-group">
      <label for="description">Description:</label>
      <textarea id="description" placeholder="Enter crime description here..."></textarea>
    </div>

    <!-- Submit Button -->
    <div class="form-group">
      <button class="submit-button" onclick="submitReport()">Submit Report</button>
    </div>
  </div>
  <script>    
  async function submitReport() {
  const userName = document.getElementById("userName").value;
  const pincode = document.getElementById("pincode").value;
  const policeStation = document.getElementById("policeStation").value;
  const phoneNumber = document.getElementById("phoneNumber").value;
  const crimeType =
    document.getElementById("crimeType").value === "others"
      ? document.getElementById("customCrimeTypeInput").value
      : document.getElementById("crimeType").value;
  const description = document.getElementById("description").value;

  // Image and voice file handling
  const imageFile = document.getElementById("uploadImage").files[0];
  const voiceFile = document.getElementById("uploadVoice").files[0];

  // FormData to send data to the backend
  const formData = new FormData();
  formData.append("user_name", userName);
  formData.append("pincode", pincode);
  formData.append("police_station", policeStation);
  formData.append("phone_number", phoneNumber);
  formData.append("crime_type", crimeType);
  formData.append("description", description);

  // Append files if they exist
  if (imageFile) {
    formData.append("image_file", imageFile); // Match the backend field name
  }
  if (voiceFile) {
    formData.append("voice_file", voiceFile); // Match the backend field name
  }

  try {
    // Fetch the access token from localStorage
    const accessToken = localStorage.getItem("access_token");
    if (!accessToken) {
      throw new Error("No access token found. Please log in.");
    }

    // Send the POST request to the `/upload-crime-report` endpoint
    const response = await fetch("http://localhost:8000/upload-crime-report", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${accessToken}`,
      },
      body: formData,
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.detail || "Failed to submit report");
    }

    const result = await response.json();

    // Show success popup with ticket number
    showSuccessPopup(result.ticket_number);
  } catch (error) {
    console.error("Error submitting report:", error);
    alert(error.message || "Failed to submit report. Please try again.");
  }
}

function showSuccessPopup(ticketNumber) {
  const popup = document.createElement("div");
  popup.innerHTML = `
    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 2px solid blue; z-index: 1000; text-align: center;">
        <h2>Report Submitted Successfully!</h2>
        <p>Your Ticket Number is: <strong>${ticketNumber}</strong></p>
        <button onclick="this.parentElement.remove(); window.location.href='user_dashboard.html'">View Dashboard</button>
    </div>
  `;
  document.body.appendChild(popup);
}


    // Function to analyze image and dynamically update description and crime type
    async function analyzeImage(file) {
        const API_KEY = 'AIzaSyBXr_EYbwC-JA4tJ_F37fctbzgKDcxTzZo'; // Replace with your actual API key

        const reader = new FileReader();
        reader.readAsDataURL(file);
        
        return new Promise((resolve, reject) => {
            reader.onload = async () => {
                const base64Image = reader.result.split(',')[1];

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${API_KEY}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: 'Analyze this image and provide the following in a structured JSON format: {"keywords": [], "crime_type": "", "description": ""}. If no specific crime is evident, set crime_type to null. Make crime_type match existing dropdown options (theft, vandalism, assault, fraud, or others). If not in the list then the real type should be appended in the dropdown and selected automatically. If not a crime then give in the description not a crime and update the type of crime as No Criminal Activity.' },
                                    { 
                                        inlineData: {
                                            mimeType: 'image/jpeg',
                                            data: base64Image
                                        }
                                    }
                                ]
                            }]
                        })
                    });

                    const data = await response.json();
                    let analysisResult;
                    try {
                        // More robust parsing to handle potential formatting issues
                        const responseText = data.candidates[0].content.parts[0].text
                            .replace(/```json/g, '')
                            .replace(/```/g, '')
                            .trim();
                        
                        analysisResult = JSON.parse(responseText);
                    } catch (parseError) {
                        console.error('Failed to parse JSON:', parseError);
                        throw new Error('Unable to parse Gemini response');
                    }

                    const descriptionBox = document.getElementById("description");
                    const crimeTypeDropdown = document.getElementById("crimeType");
                    const customCrimeTypeInput = document.getElementById("customCrimeTypeInput");
                    const customCrimeTypeContainer = document.getElementById("customCrimeType");

                    // Clear the description field
                    descriptionBox.value = "";

                    // Append keywords and description to the description
                    descriptionBox.value = `Keywords: ${analysisResult.keywords.join(", ")}\n\nDescription: ${analysisResult.description}`;

                    // Update crime type dropdown
                    if (analysisResult.crime_type) {
                        // Normalize crime type to match dropdown options
                        const normalizedCrimeType = analysisResult.crime_type.toLowerCase();
                        
                        // Check if the crime type matches any existing options
                        const existingOption = Array.from(crimeTypeDropdown.options).find(
                            option => option.value.toLowerCase() === normalizedCrimeType
                        );

                        if (existingOption) {
                            // Select the matching existing option
                            crimeTypeDropdown.value = existingOption.value;
                            customCrimeTypeContainer.style.display = 'none';
                        } else {
                            // If no match, select 'others' and set the custom input
                            crimeTypeDropdown.value = 'others';
                            customCrimeTypeInput.value = analysisResult.crime_type;
                            customCrimeTypeContainer.style.display = 'block';
                        }
                    }

                    resolve(analysisResult);
                } catch (error) {
                    console.error('Error analyzing image:', error);
                    alert('Image analysis failed. Please try again or manually enter details.');
                    reject(error);
                }
            };

            reader.onerror = (error) => {
                console.error('Error reading file:', error);
                alert('Error reading image file. Please try again.');
                reject(error);
            };
        });
    }

    // Event listener for image upload
    document.getElementById("uploadImage").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
            analyzeImage(file);
        }
    });

    // Event listener for crime type dropdown to show/hide custom input
    document.getElementById("crimeType").addEventListener("change", function() {
        const customInput = document.getElementById('customCrimeType');
        customInput.style.display = this.value === 'others' ? 'block' : 'none';
    });

  </script>
</body>
</html>
